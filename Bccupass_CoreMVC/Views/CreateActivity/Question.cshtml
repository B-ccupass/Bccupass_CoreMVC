@using Bccupass_CoreMVC.Models.ViewModel.CreateActivity
@model List<CreateQAViewModel>

@section Topcss {
    <link rel="stylesheet" href="~/css/CreateActivity/Question.css" />
}
<div class="container-md m-auto bg-white container-style">
    <div class="ticket m-auto pt-5 pb-5">
        <form method="post" action="/CreateActivity/Question">
           <input type="hidden" name="ActivityDraftId" value="@ViewData["ActivityDraftId"]" />
            <div class="border-bottom group">
                <div class="d-md-flex flex-wrap mb-4">
                    <div class="col-12 col-md-7">
                        <p class="d-inline" style="font-size: 20px;">
                            為你的新增常見問答吧！ <div class="btn-dark rounded-circle d-inline-block icon-div"><i class="far fa-lightbulb"></i></div>
                        </p>    
                        <span>新增問答可以讓參加者或興趣者，能從常見問答中快速解決自己問題；節省主辦方重複回答同樣問題的時間！</span>
                    </div>
                    <div class="text-center mt-5 col-12 col-md-5 d-flex justify-content-md-end justify-content-around">
                        <button class="ticket-btn btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#DeleteModal"><i class="fas fa-trash-alt"></i>刪除問答</button>
                        <button class="ticket-btn btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#groupModal"><i class="fas fa-lightbulb"></i>新增問答</button>
                    </div>
                </div>
                <div class="overflow-auto">
                    <table class="table border accordion"  id="accordionExample">
                        <thead class="table-dark border border-dark thead-min-width">
                        <tr>
                            <th scope="col"></th>
                            <th scope="col"><input type="checkbox" name="all" onclick="//全選JS//" /></th>
                            <th scope="col" class="" colspan="4">問題</th>
                            <th scope="col">詳情</th>
                        </tr>
                        </thead>
                        <tbody>
                            @if(Model.Any(x =>x.ActivityQuest != ""))
                            {
                                foreach(var item in Model)
                                {
                                    @await Html.PartialAsync("_QuestionListPartial",item)
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="mt-3 mb-5">
                <button class="btn btn-success w-100 p-0 pt-1 pb-1"  type="submit">儲存變更</button>
            </div>


            <!-- Modal-Delete -->
            <div class="modal fade"id="DeleteModal" tabindex="-1" aria-labelledby="DeleteModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered m-auto model-width" >
                    <div class="modal-content">
                        <div class="modal-body text-center lh-lg pt-3 pe-3">
                            確定刪除此問答？
                        </div>
                        <div class="modal-footer p-0 flex-nowrap">
                            <button class="btn border-0 p-1 col-6 m-0 border-end" data-bs-dismiss="modal">取消</button>
                            <button type="button"  id="delete" class="btn border-0 p-1 col-6 m-0 lh-lg">確認</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal-Add-Question -->
            <div class="modal fade" id="groupModal" tabindex="-1" aria-labelledby="groupModalLabel" aria-hidden="true">
                <div class="modal-dialog m-0 m-auto modal-dialog-centered">
                    <div class="modal-content question-model m-auto">
                        <div class="modal-body lh-lg m-3">
                            <p>問題:</p>
                            <input id="newQ" type="text" class="col-md-11 col-10 mb-4 input-text">
                            <p>回答:</p>
                            <textarea name="" id="newA" cols="30" rows="10" class="col-md-11 col-10" style="resize:none;"></textarea>
                        </div>
                        <div class="modal-footer p-0 flex-nowrap">
                            <button class="btn border-0 p-1 col-6 m-0 border-end" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn border-0 p-1 col-6 m-0 lh-lg" id="createCon">確認</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Model-Edit-Question -->
            <div class="modal fade" id="EditModal" tabindex="-1" aria-labelledby="EditModalLabel" aria-hidden="true">
                <div class="modal-dialog m-0 m-auto modal-dialog-centered">
                    <div class="modal-content question-model m-auto">
                        <div class="modal-body lh-lg m-3">
                            <input type="hidden" id="sort"/>
                            <p>問題:</p>
                            <input id="quest" type="text" class="col-md-11 col-10 bg-secondary mb-4 input-text">
                            <p>回答:</p>
                            <textarea name="" id="" cols="30" rows="10" class="col-md-11 col-10" style="resize:none;"></textarea>
                        </div>
                        <div class="modal-footer p-0 flex-nowrap">
                            <button class="btn border-0 p-1 col-6 m-0 border-end" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn border-0 p-1 col-6 m-0 lh-lg" id="edit">確認修改</button>
                        </div>
                    </div>
                </div>
            </div>

            <input type="hidden" id="QAJson" name="GuestDataJson"/>
        </form>
    </div>
            
</div>


@section endJS {

    <script>
        var newQuestion = document.getElementById('newQ')
        var newAnswer = document.getElementById('newA')
        var createBtn = document.getElementById('createCon')
        var editBtn = document.getElementById('edit')
        var deleteBtn = document.getElementById('delete')

        const outputJson = document.getElementById('QAJson')

        let dataArray = []
        let data

        function getQAData(sort){
            var question = document.getElementById(`Quest${sort}`)
            var answer = document.getElementById(`Answer${sort}`)
            var sortItem = document.getElementById(`sort${sort}`)

            let model = document.getElementById(`EditModal`)

            model.querySelector('#sort').value = sortItem.value
            model.querySelector('#quest').value = question.textContent
            model.querySelector('textarea').value = answer.textContent
        }
       
        createBtn.onclick =  function(){
            
            data = {
                ActivityDraftId: @ViewData["ActivityDraftId"],
                ActivityQuest: newQuestion.value,
                ActivityAnswer: newAnswer.value,
                Sort: dataArray.length
            }

            dataArray.push(data)

            outputJson.setAttribute('value',JSON.stringify(dataArray))    
            var myModal = document.querySelector(`#groupModal`)
            bootstrap.Modal.getOrCreateInstance(myModal).hide();
        }

        editBtn.onclick = function(){
            let model = document.getElementById(`EditModal`)

            var sort = model.querySelector('#sort').value 
            var question = model.querySelector('#quest').value 
            var answer = model.querySelector('textarea').value 

            dataArray.forEach(data =>{
                if(data.Sort == sort){
                    data.ActivityQuest = question
                    data.ActivityAnswer = answer
                }
            })

            outputJson.setAttribute('value',JSON.stringify(dataArray))    
            var myModal = document.querySelector(`#EditModal`)
            bootstrap.Modal.getOrCreateInstance(myModal).hide();
        }

        deleteBtn.onclick = function(){
            var target = document.querySelectorAll('.checked')
            for(var i = 0; i < target.length; i++){
                if(target[i].checked){
                    
                    dataArray.splice(dataArray.findIndex(x => x.Sort == target[i].Value),1)
                }
            }
             for(var i = 0; i < dataArray.length;i++){
                dataArray[i].Sort = i
            }

            outputJson.setAttribute('value',JSON.stringify(dataArray))    
            var myModal = document.querySelector(`#DeleteModal`)
            bootstrap.Modal.getOrCreateInstance(myModal).hide();
        }
        

    </script>


     @foreach(var item in Model){
        <script type="text/javascript">
            data = {
                ActivityDraftId: @item.ActivityDraftId,
                ActivityQuest: "@item.ActivityQuest",
                ActivityAnswer: "@item.ActivityAnswer",
                Sort: @item.Sort
            }

            dataArray.push(data)

            outputJson.setAttribute('value',JSON.stringify(dataArray)) 
        </script>
    }
}


