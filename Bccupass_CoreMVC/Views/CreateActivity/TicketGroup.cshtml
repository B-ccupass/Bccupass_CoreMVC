@using Bccupass_CoreMVC.Models.ViewModel.CreateActivity
@using Newtonsoft.Json
@model List<CreateTicketViewModel>

@section Topcss {
     <link rel="stylesheet" href="~/css/CreateActivity/TicketGroup.css" />
}

<div class="container-md m-auto bg-white container-style">
    <div class="ticket m-auto pt-5 pb-5 col-12">
            <div class="border-bottom group" id="vue">
                <div class="d-md-flex flex-wrap mb-4">
                    <div class="col-12 col-md-7">
                        <p class="d-inline" style="font-size: 20px;">
                            開始為你的票券設定分組吧！ <div class="btn-dark rounded-circle d-inline-block icon-div"><i class="far fa-lightbulb"></i></div>
                        </p>    
                        <span>票券分組可以將票券分類歸納，依據時間或地點分組管理；消費者在購票頁面中更容易選購！</span>
                    </div>
                    <div class="text-center mt-5 col-12 col-md-5 d-flex justify-content-md-end justify-content-around">
                        <button class="ticket-btn" type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#DeleteModal"><i class="fas fa-trash-alt"></i>刪除分組</button>
                        <button class="ticket-btn" type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#groupModal"><i class="fas fa-layer-group"></i>票卷分組</button>
                    </div>
                </div>
                <div class="overflow-auto">
                    <table class="table border accordion"  id="accordionExample">
                        <thead class="table-dark border border-dark thead-min-width">
                        <tr>
                            <th scope="col"></th>
                            <th scope="col"><input type="checkbox" name="all" :checked="allCheck" /></th>
                            <th scope="col">票券分組名稱</th>
                            <th scope="col">票券名稱</th>
                            <th scope="col">票券數量</th>
                            <th scope="col">票價</th>
                            <th scope="col">操作</th>
                        </tr>
                        </thead>
                        <tbody>
                          @foreach(var item in Model)
                            {
                                @await Html.PartialAsync("_ticketGroupPartial",item)
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="mt-3 mb-5">
                <button type="submit" class="btn btn-success w-100 p-0 pt-1 pb-1" onclick="addTicketFetch()">儲存變更</button>
            </div>


            <!-- Modal-Delete -->
            <div class="modal fade"id="DeleteModal" tabindex="-1" aria-labelledby="DeleteModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered m-auto model-width" >
                    <div class="modal-content">
                        <div class="modal-body text-center lh-lg pt-3 pe-3">
                            確定刪除此票種分組？
                        </div>
                        <div class="modal-footer p-0 flex-nowrap">
                            <button class="btn border-0 p-1 col-6 m-0 border-end" data-bs-dismiss="modal">取消</button>
                            <button id="delete" type="button" class="btn border-0 p-1 col-6 m-0 lh-lg">確認</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal-group -->
            <div class="modal fade" id="groupModal" tabindex="-1" aria-labelledby="groupModalLabel" aria-hidden="true">
                <div class="modal-dialog m-0 m-auto modal-dialog-centered model-width">
                    <div class="modal-content">
                        <div class="modal-body lh-lg pt-3 pe-3">
                            <p>票券分組名稱</p>
                            <input id="groupName" type="text" class="col-md-11 col-10 ">
                        </div>
                        <div class="modal-footer p-0 flex-nowrap">
                            <button class="btn border-0 p-1 col-6 m-0 border-end" data-bs-dismiss="modal">取消</button>
                            <button id="groupBtn" type="button" class="btn border-0 p-1 col-6 m-0 lh-lg">確認</button>
                        </div>
                    </div>
                </div>
            </div>
    </div>
            
</div>

@section endJS{
    <script>
        let vueObj = new Vue({
            el: "#vue",
            data:{
                dataArray : @Html.Raw(JsonConvert.SerializeObject(Model)),
                allCheck: false
            }
        })

        var deleteBtn = document.getElementById('delete')
        var groupBtn = document.getElementById('groupBtn')

        var groupInput = document.getElementById('groupName')
        let dataArray = vueObj.dataArray

        deleteBtn.onclick = function(){
            var target = document.querySelectorAll('.checked')
            for(var i = 0; i < target.length; i++){
                if(target[i].checked){
                    dataArray.forEach(item => {
                        if(item.Sort == target[i].value){
                            item.TicketGroup = ''
                        }
                    })
                }
            }
 
            var myModal = document.querySelector(`#DeleteModal`)
            bootstrap.Modal.getOrCreateInstance(myModal).hide();
        }

        groupBtn.onclick = function(){
            var target = document.querySelectorAll('.checked')
            
            for(var i = 0; i < target.length; i++){
                if(target[i].checked){
                    dataArray.forEach(item => {
                        if(item.Sort == target[i].value){
                            item.TicketGroup = groupInput.value
                        }
                    })
                }
            }
   
            var myModal = document.querySelector(`#groupModal`)
            bootstrap.Modal.getOrCreateInstance(myModal).hide();
        }

         function addTicketFetch(){
            fetch("/CreateActivity/FetchTicketGroup", {
                headers: {
                    'Accept': 'application/json, text/plain',
                    'Content-Type': 'application/json;charset=UTF-8'
                },
                method: 'POST',
                body: JSON.stringify(dataArray)
            })
            //.then(response => {
            //    response.json()
            //    window.location.reload()
            //})

            fetch(`/CreateActivity/DemoDraftJson/${@ViewData["ActivityDraftId"]}`, { method: 'GET' })
            .then(res=> location.assign(res.url))
        }
    
    </script>
}