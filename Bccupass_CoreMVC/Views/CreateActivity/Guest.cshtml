@using Bccupass_CoreMVC.Models.ViewModel.CreateActivity
@model List<CreateGuestViewModel>

@{
   string jsontoJS =  Newtonsoft.Json.JsonConvert.SerializeObject(Model);
}

@section Topcss {
    <link rel="stylesheet" href="~/css/CreateActivity/Guest.css" />
}

<div class="container-md m-auto bg-white container-style">
    <div class="activity m-auto p-5">
        <form method="post" action="/CreateActivity/Guest">            
            <input type="hidden" name="ActivityDraftId" value="@ViewData["ActivityDraftId"]" />
            <div class="col-12 border-bottom">
                <p class="d-inline activity_p">
                    快來介紹你的來賓有多厲害！ <div class="btn-dark rounded-circle d-inline-block icon-div"><i class="far fa-lightbulb"></i></div>
                </p>    
                <div class="mt-5 guest">
                    @if(Model.Any(x =>x.GuestName != null))
                    {
                        foreach(var item in Model)
                        {
                            if (item.GuestName != "")
                            {
                                @await Html.PartialAsync("_photoNamePartial", item)
                            }
                        }
                    }

                    <div class="me-4">
                        <div class="rounded-circle text-center icon-plus guest-photo" type="button" data-bs-toggle="modal" data-bs-target="#GuestModal">
                            <i class="fas fa-plus"></i>
                        </div>
                        <div class="text-center">
                            <p class="mt-3">新增嘉賓</p>
                        </div>
                    </div>                
                </div>

            </div>
            
        

            <!-- Modal -->
            @if(Model.Any(x =>x.GuestName != null))
                    {
                        foreach(var item in Model)
                        {
                            if(item.GuestName != "")
                            {
                                @await Html.PartialAsync("_CeateGuestPartial", item)
                            }
                        }
                    }
            <div class="modal fade"id="GuestModal" tabindex="-1" aria-labelledby="GuestModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered m-auto model-width" >
                    <div class="modal-content guest-model m-auto">
                        <div class="modal-body lh-lg pt-3 pe-3">
                                <div class="guest-model-top m-auto">
                                    <img id="guest-imgGuestModal" src="https://static.accupass.com/frontend/image/eventedit/organizer/organizer_avatar_placeholder.svg" alt="">
                                    <button class="">
                                        <i class="fa fa-camera"></i>
                                    </button>
                                    <inpu type="file" accept="image/*" style="display: none;">
                                </div>
                            <div class="col-12 guest-model-content">                
                                <div>
                                    <p class="fw-bold">嘉賓姓名<span>*</span></p>
                                    <input id="guest-nameGuestModal" type="text" placeholder="填寫嘉賓姓名">
                                </div>
                
                                <div>
                                    <p class="fw-bold">職稱<span>*</span></p>
                                    <input id="guest-jobGuestModal" type="text" placeholder="填寫嘉賓職稱">
                                </div>
                
                                <div>
                                    <p class="fw-bold">公司名稱<span>*</span></p>
                                    <input id="guest-companyGuestModal" type="text" placeholder="填寫嘉賓公司名稱">
                                </div>
                                <div>
                                    <p class="fw-bold">嘉賓簡介<span>*</span></p>
                                    <textarea style="resize:none;" class="w-100 " id="guest-infoGuestModal" rows="4"></textarea>
                                </div>
                                <div>
                                    <p class="fw-bold">嘉賓網址<span>*</span></p>
                                    <span>可以加上嘉賓的 Facebook、Instagram、Twitter 等</span>
                                    <input id="guest-webGuestModal" type="text" placeholder="填寫嘉賓網址">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer p-0 flex-nowrap mt-4">
                            <button id="modelBtn" class="btn border-0 p-1 col-12 m-0 lh-lg bg-primary text-white" type="button" onclick="makeJson('GuestModal')">新增嘉賓</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Modal -->

            <input type="hidden" id="guestJson" name="GuestDataJson"/>

            <div class="mt-3 mb-5">
                <button type="submit" id="formBtn" class="btn btn-success w-100">儲存變更</button>
            </div>
        </form>
    </div>
            
            
</div>

@section endJS {
    
    
    <script>
       

        const outputJson = document.getElementById('guestJson')

        const modelBtn = document.querySelector('#modelBtn')
        const formBtn = document.getElementById('formBtn')

        let dataArray = []
        let data

        function makeJson(id){

            const guest_img = document.getElementById(`guest-img${id}`)
            const guest_name = document.getElementById(`guest-name${id}`)
            const guest_job = document.getElementById(`guest-job${id}`)
            const guest_company = document.getElementById(`guest-company${id}`)
            const guest_info = document.getElementById(`guest-info${id}`)
            const guest_web = document.getElementById(`guest-web${id}`)

            var myModal = document.querySelector(`#model${id}`)
            
            if(id != "GuestModal"){
                dataArray.forEach(item => {
                    if(item.ItemId == id){
                        item.GuestName = guest_name.value,
                        item.GuestJob = guest_job.value,
                        item.GuestCompany = guest_company.value,
                        item.GuestInfo = guest_info.value,
                        item.GuestWeb = guest_web.value
                    }
                })

                outputJson.setAttribute('value',JSON.stringify(dataArray))
            
                bootstrap.Modal.getOrCreateInstance(myModal).hide();

                return;
            }

            


            data = {
                ActivityDraftId: @ViewData["ActivityDraftId"],
                GuestImage: "",
                GuestName: guest_name.value,
                GuestJob: guest_job.value,
                GuestCompany: guest_company.value,
                GuestInfo: guest_info.value,
                GuestWeb: guest_web.value,
                ItemId: dataArray.length
            }
            debugger
            dataArray.push(data)
            
            outputJson.setAttribute('value',JSON.stringify(dataArray))

            
            bootstrap.Modal.getOrCreateInstance(myModal).hide();
            
        }

        function deleteGuest(id){
            var myModal = document.querySelector(`#model${id}`)
            dataArray.forEach(item => {
                    if(item.ItemId == id){
                        dataArray.splice(dataArray.findIndex(index => index == item),1)
                    }
                })
             outputJson.setAttribute('value',JSON.stringify(dataArray))
            
            bootstrap.Modal.getOrCreateInstance(myModal).hide();

            return;
        }
     
        
    </script>

    @if(Model.Any(x => x.GuestName != null)){
        foreach(var item in Model){
            <script type="text/javascript">
                data = {
                    ActivityDraftId: @item.ActivityDraftId,
                    GuestImage: "" @*@item.GuestImg*@,
                    GuestName: `@item.GuestName`,
                    GuestJob: `@item.GuestJob`,
                    GuestCompany: `@item.GuestCompany`,
                    GuestInfo: `@item.GuestInfo`,
                    GuestWeb: `@item.GuestWeb`,
                    ItemId: `@item.ItemId`
                }

                dataArray.push(data)

                outputJson.setAttribute('value',JSON.stringify(dataArray))   
            </script>
    }
    }
}